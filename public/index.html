<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Results Dashboard</title>
  <link rel="shortcut icon" href="images/gkg.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-2 sm:px-4 lg:px-6 py-4">
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-4 sm:space-y-0">
      <!-- Title -->
      <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 order-2 sm:order-1">
        Exam Results
      </h1>
      
      <!-- Logo - centered on mobile, centered in available space on larger screens -->
      <div class="flex justify-center sm:flex-1 order-1 sm:order-2">
        <a href="#" class="block">
          <img 
            src="images/GGPC logo.png" 
            alt="Logo" 
            class="w-20 h-20 sm:w-24 sm:h-24 lg:w-32 lg:h-32 object-contain rounded hover:opacity-80 transition-opacity" 
          />
        </a>
      </div>
      
      <!-- Spacer for desktop alignment -->
      <div class="hidden sm:block sm:w-16 lg:w-24 order-3"></div>
    </div>

    <!-- Search + Filters Section -->
    <div class="mb-4 sm:mb-6 grid grid-cols-1 sm:grid-cols-3 gap-3 items-center">
      <div class="sm:col-span-2">
        <input
          type="text"
          id="searchInput"
          placeholder="Search by name or email..."
          class="w-full p-3 sm:p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm sm:text-base"
        />
      </div>

      <!-- Status filter -->
      <div class="flex items-center space-x-2">
        <label for="statusFilter" class="text-sm text-gray-600 hidden sm:inline">Status:</label>
        <select id="statusFilter" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm">
          <option value="">All Statuses</option>
        </select>
      </div>
    </div>

    <!-- Results Counter -->
    <div class="mb-4">
      <p id="resultsCount" class="text-sm text-gray-600 font-medium"></p>
    </div>

    <!-- Table Section -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <!-- Mobile Card View -->
      <div id="mobileView" class="block sm:hidden">
        <div id="mobileResults" class="divide-y divide-gray-200"></div>
        <div id="noResultsMobile" class="hidden p-6 text-center text-gray-500">
          No results found
        </div>
      </div>

      <!-- Desktop/Tablet Table View -->
      <div id="tableView" class="hidden sm:block overflow-x-auto">
        <table id="resultsTable" class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Name
              </th>
              <th class="px-3 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Email
              </th>
              <th class="px-3 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Score
              </th>
              <th class="px-3 py-3 sm:px-6 sm:py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Status
              </th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
          </tbody>
        </table>
        <div id="noResultsTable" class="hidden p-6 text-center text-gray-500">
          No results found
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="flex justify-center items-center py-12">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      <span class="ml-3 text-gray-600">Loading results...</span>
    </div>
  </div>

  <script>
    let allResults = [];
    let filteredResults = [];

    async function loadData() {
      try {
        const resp = await fetch('/.netlify/functions/proxy');
        const { success, results, error } = await resp.json();
        
        document.getElementById('loadingState').style.display = 'none';
        
        if (!success) {
          alert('Error: ' + error);
          return;
        }
        
        // results expected newest-first from proxy
        allResults = Array.isArray(results) ? results : [];
        populateStatusFilter(allResults);
        applyFilters(); // render initial
      } catch (err) {
        document.getElementById('loadingState').style.display = 'none';
        alert('Error loading data: ' + err.message);
      }
    }

    function populateStatusFilter(data) {
      const select = document.getElementById('statusFilter');
      const statuses = new Set();
      data.forEach(r => {
        const s = r["Exam Status"] || r.Status || r.status || '';
        if (s && String(s).trim() !== '') statuses.add(String(s).trim());
      });
      // Clear existing (keep first "All" option)
      select.innerHTML = '<option value="">All Statuses</option>';
      Array.from(statuses).sort().forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
      });
    }

    // Apply search + status filters and render
    function applyFilters() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const statusVal = document.getElementById('statusFilter').value.toLowerCase().trim();

      filteredResults = allResults.filter(r => {
        // status filter
        if (statusVal) {
          const s = (r["Exam Status"] || r.Status || r.status || '').toString().toLowerCase();
          if (!s.includes(statusVal)) return false;
        }
        // search filter
        if (!query) return true;
        const name = (r.Name || '').toString().toLowerCase();
        const email = (r.Email || '').toString().toLowerCase();
        return name.includes(query) || email.includes(query);
      });

      renderResults(filteredResults);
      updateResultsCount(filteredResults.length, allResults.length);
    }

    function renderResults(data) {
      renderMobileView(data);
      renderTableView(data);
      
      // Show/hide no results messages
      const noResults = data.length === 0;
      document.getElementById('noResultsMobile').style.display = noResults ? 'block' : 'none';
      document.getElementById('noResultsTable').style.display = noResults ? 'block' : 'none';
    }

    function renderMobileView(data) {
      const container = document.getElementById('mobileResults');
      container.innerHTML = '';

      data.forEach(r => {
        const card = document.createElement('div');
        card.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors active:bg-gray-100';
        card.onclick = () => viewResult(r.Email);
        
        // Determine status color
        const status = r["Exam Status"] || r.Status || '';
        let statusColor = 'text-gray-600';
        if (status.toLowerCase().includes('pass')) statusColor = 'text-green-600';
        else if (status.toLowerCase().includes('fail')) statusColor = 'text-red-600';
        
        card.innerHTML = `
          <div class="space-y-2">
            <div class="font-semibold text-gray-900 text-base">
              ${r.Name || 'N/A'}
            </div>
            <div class="text-sm text-gray-600 break-all">
              ${r.Email || 'N/A'}
            </div>
            <div class="flex justify-between items-center pt-2">
              <div class="text-lg font-bold text-blue-600">
                ${r.Score || 'N/A'}
              </div>
              <div class="text-sm font-medium ${statusColor} px-2 py-1 bg-gray-100 rounded">
                ${status || 'N/A'}
              </div>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-400 text-right">
            Tap to view details â†’
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function renderTableView(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer transition-colors';
        tr.onclick = () => viewResult(r.Email);
        
        // Determine status styling
        const status = r["Exam Status"] || r.Status || '';
        let statusClass = 'text-gray-600';
        if (status.toLowerCase().includes('pass')) statusClass = 'text-green-600 font-medium';
        else if (status.toLowerCase().includes('fail')) statusClass = 'text-red-600 font-medium';
        
        tr.innerHTML = `
          <td class="px-3 py-4 sm:px-6 whitespace-nowrap text-sm font-medium text-gray-900">
            ${r.Name || 'N/A'}
          </td>
          <td class="px-3 py-4 sm:px-6 text-sm text-gray-600 max-w-xs truncate" title="${r.Email || ''}">
            ${r.Email || 'N/A'}
          </td>
          <td class="px-3 py-4 sm:px-6 whitespace-nowrap text-sm font-bold text-blue-600">
            ${r.Score || 'N/A'}
          </td>
          <td class="px-3 py-4 sm:px-6 whitespace-nowrap text-sm ${statusClass}">
            ${status || 'N/A'}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateResultsCount(showing, total) {
      const countEl = document.getElementById('resultsCount');
      if (showing === total) {
        countEl.textContent = `Showing ${total} result${total !== 1 ? 's' : ''}`;
      } else {
        countEl.textContent = `Showing ${showing} of ${total} results`;
      }
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', () => {
      applyFilters();
    });

    // Status filter change
    document.getElementById('statusFilter').addEventListener('change', () => {
      applyFilters();
    });

    function viewResult(email) {
      if (!email) return;
      const encoded = encodeURIComponent(email);
      window.location.href = `/results.html?email=${encoded}`;
    }

    // Initialize
    loadData();
  </script>
</body>
</html>